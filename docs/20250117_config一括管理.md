# Config 設定一括管理 実装計画

## 📋 実装概要

test_mode の値に基づいて、システム全体の設定を一括管理する仕組みを構築します。

## 🎯 実装目標

- test_mode による設定の自動切り替え
- 設定項目の一元管理
- 環境ごとの適切なリソース利用

## 📝 実装手順

### 001 Config 設定メソッドの再構築

**todo**

- [x] test_mode に基づく設定切り替えメソッドを作成
- [x] LINE 設定の分岐処理を追加
- [x] ファイルパス設定の分岐処理を追加
- [x] ネットワークドライブ設定の分岐処理を追加

**how**

- `_configure_for_test_mode()` メソッドを追加
- `_configure_for_production_mode()` メソッドを追加
- 各設定項目を test_mode に基づいて動的設定

**memo**

- test_mode=True: 開発・デバッグ用設定
- test_mode=False: 本番用設定

### 002 LINE 設定の管理機能強化

**todo**

- [x] テスト用 LINE 設定を定義
- [x] 本番用 LINE 設定を定義
- [x] 設定切り替えメソッドを実装

**how**

- テスト用・本番用の LINE 設定を分離
- `_configure_test_line_settings()` / `_configure_production_line_settings()` メソッドで動的取得
- 環境変数との連携も維持

**memo**

- テスト: 既存の LINE シークレット使用
- 本番: 新しい LINE シークレット使用

### 003 ファイルパス管理の改善

**todo**

- [x] ローカルファイルパス設定を整備
- [x] Windows ネットワークドライブパス設定を整備
- [x] マスタファイルパスの動的設定を追加

**how**

- `_configure_for_test_mode()` / `_configure_for_production_mode()` メソッドで環境別パス取得
- test_mode=True: ローカルパス使用
- test_mode=False: ネットワークドライブパス使用

**memo**

- マスタファイルも test_mode で切り替え
- 出力先も環境に応じて自動設定

### 004 スクレイピング設定の追加

**todo**

- [x] 確定処理フラグの設定を追加
- [x] headless_mode の自動設定を修正
- [x] スクレイピング動作制御を実装

**how**

- `enable_confirmation_process` フラグを追加
- test_mode に基づく headless_mode 設定
- SMCLScraper での確定処理制御

**memo**

- test_mode=True: 確定処理なし、headless=False
- test_mode=False: 確定処理あり、headless=True

### 005 設定状況確認機能の追加

**todo**

- [x] 現在の設定状況を表示する機能
- [x] test_mode の切り替え方法の案内
- [x] 設定検証機能の実装

**how**

- `print_configuration_status()` メソッドを拡張
- test_mode による設定差異の明示
- 設定エラーの自動検出

**memo**

- デバッグ用の設定確認を充実
- 運用時の設定ミスを防止

## ✅ 完了チェック項目

- [x] Config.**init**で test_mode に基づく設定切り替えが動作する
- [x] test_mode=True でローカル設定が適用される
- [x] test_mode=False でネットワーク設定が適用される
- [x] LINE 設定が環境に応じて切り替わる
- [x] スクレイピングの確定処理が制御される
- [x] 設定状況確認機能が正常に動作する

## 🎉 実装完了！

すべての設定項目が test_mode によって一括管理され、さらに個別制御機能も追加されました。

## 🔍 追加実装：検索条件の統一

### 検索日付入力の統一化

**要件**: スクレイピング時の検索条件で、test_mode に関係なく今日の日付を入力したい

**実装内容**:

- `SMCLScraper._set_search_date()` メソッドを追加
- `ctl00_ContentPlaceHolder1_FormView1_ImpDateFromTextBox` に今日の日付を入力
- test_mode に関係なく常に実行
- 日付フォーマット: `YYYY/MM/DD`

**修正箇所**:

```python
# services/scraping/smcl_scraper.py
def _set_search_date(self):
    today_str = datetime.now().strftime('%Y/%m/%d')
    date_input.send_keys(today_str)  # 今日の日付を入力
```

## 📭 追加実装：該当データなし時の LINE 通知

### 該当データなし状態の検出と LINE 通知機能

**要件**: 検索時に「該当するデータがありません。」が表示された場合、専用の LINE 通知を送信したい

**実装内容**:

#### 🔍 **データなし検出機能**

- `SMCLScraper._check_no_data_message()` メソッドを追加
- メッセージエリア（ID: `ctl00_messageArea_RepeatMessage_ctl00_messageLabel`）をチェック
- 「該当するデータがありません」を含むメッセージを検出
- `self.no_data_found = True` で状態を保存

#### 📱 **専用 LINE 通知機能**

- `DeliveryListProcessor._send_no_data_notification()` メソッドを追加
- スクレイピング後に `scraper.no_data_found` をチェック
- データなしの場合、専用メッセージを LINE 送信
- メッセージ: 「📭 受注データ確認結果\n\n{today_str}の受注データが見つかりませんでした。\n\n 本日は新しい受注がない可能性があります。」

#### ⚙️ **処理フロー統合**

```python
# main.py
if hasattr(self.scraper, 'no_data_found') and self.scraper.no_data_found:
    self.logger.info("📭 該当するデータがありません - 専用通知を送信します")
    self._send_no_data_notification()
    return True  # 処理は成功（データがないだけ）
```

#### 🔧 **修正事項**

- **インポートエラー修正**: `LineBot` → `LineBotNotifier`
- **初期化方法修正**: 引数なしで初期化（config は内部で取得）
- **エラーハンドリング**: 通知送信失敗時もログ出力

## 🔧 設定切り替え方法

### 基本モード切り替え

#### 開発・テストモード

```python
# services/core/config.py
self.test_mode = True
```

#### 本番モード

```python
# services/core/config.py
self.test_mode = False
```

### 🚨 個別制御設定（現状運用対応）

#### 確定処理制御

**現状：テスト・本番ともに確定処理なし**

```python
# services/core/config.py の _get_confirmation_process_setting() で
CURRENT_CONFIRMATION_SETTING = False  # 現状設定

# 将来的に本番で有効にする場合：
# return not self.test_mode  # コメントアウトを解除
```

#### 検索条件制御

**現状：本番もテストと同じ検索条件**

```python
# services/core/config.py の _get_search_conditions_setting() で
CURRENT_SEARCH_SETTING = False  # 現状設定

# 将来的に本番専用条件を使う場合：
# return not self.test_mode  # コメントアウトを解除
```

### 🌍 環境変数での制御

```bash
# 確定処理を個別制御
export SMCL_ENABLE_CONFIRMATION=true

# 本番用検索条件を個別制御
export SMCL_ENABLE_PRODUCTION_SEARCH=true
```
