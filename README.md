# SMCL 納品リスト処理システム

角上魚類の納品リスト処理を自動化するシステムです。

## 📋 システム概要

このシステムは以下の処理を自動で実行します：

1. **スマクラにログイン** - Selenium を使用して Web サイトにアクセス
2. **納品リストをダウンロード** - PDF ファイルを自動取得
3. **納品データを抽出** - PDF からテキストデータを解析
4. **マスタ Excel と付け合わせ** - データの妥当性をチェック
5. **配車表・出庫依頼書の Excel 作成** - 納品先別にファイル生成
6. **LineBot で通知** - 処理結果を LINE で報告

## 🏗️ システム構成

```
scraping-smacl/
├── main.py                    # メイン実行ファイル
├── config/
│   └── settings.py           # 設定管理
├── scraping/
│   └── smcl_scraper.py      # Webスクレイピング機能
├── data/
│   ├── pdf_extractor.py     # PDF データ抽出
│   └── excel_processor.py   # Excel処理（マスタ付け合わせ、生成）
├── notification/
│   └── line_bot.py          # LINE Bot通知
├── utils/
│   └── logger.py            # ログ機能
├── downloads/               # ダウンロードファイル保存先
├── output/                  # 生成ファイル出力先
├── logs/                    # ログファイル保存先
├── master/                  # マスタファイル配置先
└── templates/              # Excelテンプレート（将来拡張用）
```

## ⚙️ セットアップ

### 1. 必要な依存関係をインストール

```bash
pip install -r requirements.txt
```

### 2. マスタファイルの配置

`master/` ディレクトリに `角上魚類　配送依頼・出庫依頼.xlsx` を配置してください。

マスタファイルには以下のカラムが必要です：

- 商品名 (必須)
- 商品コード
- 仕入先
- 単価
- 配送先 (複数列可)

### 3. LINE Bot 設定（オプション）

LINE 通知を使用する場合は、環境変数を設定してください：

```bash
export LINE_CHANNEL_ACCESS_TOKEN="your_channel_access_token"
export LINE_USER_ID="your_user_id"
```

## 🚀 実行方法

### 基本実行

```bash
python main.py
```

### 既存のスクレイピング機能のみ実行

```bash
python scrape_smcl_kakujou.py
```

## 📝 ログ

ログは以下の場所に保存されます：

- ファイル: `logs/smcl_system_YYYYMMDD.log`
- コンソール: 実行中にリアルタイム表示

## 📊 出力ファイル

### 自動生成されるファイル

1. **配車表** - `配車表_{納品先}_{タイムスタンプ}.xlsx`
2. **出庫依頼書** - `出庫依頼_{納品先}_{タイムスタンプ}.xlsx`
3. **エラーレポート** - `エラーデータ_{タイムスタンプ}.xlsx` (エラーがある場合のみ)

### 出力先

すべてのファイルは `output/` ディレクトリに保存されます。

## 🔧 設定カスタマイズ

`config/settings.py` で以下の設定を変更できます：

- **SMCL ログイン情報** - サイトアクセス設定
- **ファイルパス** - 各種ディレクトリの場所
- **処理設定** - タイムアウト、リトライ回数など
- **LINE Bot 設定** - 通知機能の設定

## 🛠️ トラブルシューティング

### よくある問題

#### 1. ChromeDriver エラー

```
ChromeDriverの初期化エラー
```

**解決方法:** Chrome ブラウザが最新版であることを確認してください。webdriver-manager が自動でドライバーを管理します。

#### 2. PDF が読み取れない

```
PDFからテキストが抽出できませんでした
```

**解決方法:**

- PDF ファイルが破損していないか確認
- `pdfplumber` の代わりに `PyMuPDF` を試す場合は settings.py で設定変更

#### 3. マスタファイルが見つからない

```
マスタファイルが見つかりません
```

**解決方法:** `master/角上魚類　配送依頼・出庫依頼.xlsx` が正しく配置されているか確認

#### 4. LINE 通知が送信されない

```
LINE Bot設定が不完全です
```

**解決方法:** 環境変数 `LINE_CHANNEL_ACCESS_TOKEN` と `LINE_USER_ID` が正しく設定されているか確認

### ログの確認

詳細なエラー情報は `logs/` ディレクトリのログファイルで確認できます。

## 📈 機能拡張

### 新しい納品先の追加

1. マスタファイルに新しい納品先を追加
2. 必要に応じて `data/excel_processor.py` の配車表・出庫依頼書テンプレートをカスタマイズ

### PDF フォーマットの変更

`data/pdf_extractor.py` の解析ロジックを修正することで、新しい PDF フォーマットに対応できます。

### 通知機能の拡張

`notification/` ディレクトリに新しい通知クラスを追加することで、メール通知等を実装できます。

## 🔐 セキュリティ注意事項

- ログイン情報は `config/settings.py` にハードコードされています
- 本番環境では環境変数からの読み込みに変更することを推奨します
- LINE Bot のアクセストークンは適切に管理してください

## 📞 サポート

問題が発生した場合は、以下の情報と共にお問い合わせください：

1. エラーメッセージ
2. ログファイルの該当箇所
3. 実行環境（OS、Python バージョン）
4. 使用しているファイル（マスタファイル等）の情報

## 📋 サンプルコード

`サンプルコード/` ディレクトリには、システムの各機能を理解するための実装例が含まれています：

### 1. add_value_to_cell

**機能:** Excel ファイルの特定セルに数値を加算する機能

- **目的:** Excel ファイルの指定されたセルの値に新しい数値を足し算
- **主な機能:**
  - 複数のシートからデータを読み取り
  - 指定されたセルに値を加算
  - ファイルが存在しない場合の新規作成対応
- **使用例:** 集計データの累積処理、在庫数の更新など
- **実行方法:** `python main.py`

### 2. get_cell_by_product_number

**機能:** 商品番号でマスタファイルを検索し、該当する行とセル位置を特定

- **目的:** 商品番号を指定してマスタファイル内での位置を検索
- **主な機能:**
  - 商品番号による検索機能
  - 見つかった行番号とセル番地の取得
  - 存在チェックとエラーハンドリング
- **使用例:** 商品マスタでの在庫確認、価格取得など
- **実行方法:** `python main.py`

### 3. extracted_orders_from_csv

**機能:** 受注伝票 Excel ファイルから商品番号と発注数量を抽出

- **目的:** 受注データから必要な情報を構造化されたデータとして抽出
- **主な機能:**
  - Excel ファイルからのデータ読み込み
  - 商品番号と発注数量の自動抽出
  - CSV/Excel 形式での出力対応
- **使用例:** 受注データの分析、発注処理の自動化など
- **実行方法:** `python main.py`
- **依存関係:** `pip install -r requirements.txt`

これらのサンプルコードは、メインシステムの各コンポーネントの理解や、新機能開発時の参考実装として活用できます。

## 📋 更新履歴

### v2.0.0 (最新)

- システム全体のモジュール化
- PDF 自動データ抽出機能
- マスタとの自動付け合わせ機能
- 配車表・出庫依頼書自動生成
- LINE Bot 通知機能
- エラーハンドリングの改善

### v1.0.0

- 基本的なスクレイピング機能
