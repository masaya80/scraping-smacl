# SMCL システム 実行手順ガイド

## 🎯 目的

このガイドでは、SMCL 納品リスト処理システムの日常的な実行手順を説明します。

## 📋 実行前チェックリスト

### 必須項目

- [ ] Python 3.13.2 がインストールされている
- [ ] マスタ Excel ファイル（`services/docs/角上魚類.xlsx`）が存在する
- [ ] インターネット接続が利用可能

### オプション項目

- [ ] ネットワークドライブ（`\\sv001\Userdata\`）へのアクセス
- [ ] Google Drive 認証設定（`credentials.json`）
- [ ] LINE Bot 設定（環境変数）

## 🚀 実行手順

### 1. システム状態確認

まず、システムが正常に動作する状態かを確認します：

```cmd
check_system.bat
```

**確認項目：**

- ✅ Python 3.13.2 インストール状況
- ✅ 仮想環境の状態
- ✅ 依存関係の状態
- ✅ 設定ファイルの存在
- ✅ マスタ Excel ファイルの存在

### 2. メインシステム実行

システム状態に問題がなければ、メインシステムを実行します：

```cmd
run_system.bat
```

### 3. 実行プロセスの確認

システム実行中は以下のフェーズが順次実行されます：

#### フェーズ 1: スクレイピング処理（現在無効化）

- SMCL サイトへのログイン
- 納品リストのダウンロード

#### フェーズ 2: CSV データ抽出 ✅

- ダウンロードされた CSV ファイルの検索
- 受注データの抽出と構造化

#### フェーズ 3: マスタ付け合わせ ✅

- マスタ Excel ファイルとの照合
- データの妥当性チェック
- エラーデータの特定

#### フェーズ 4: Excel 生成 ✅

- 倉庫別注文処理
- 既存マスタ Excel への数量挿入

#### フェーズ 5: PDF 画像変換 ✅

- 生成された PDF ファイルの画像変換
- LINE 送信用画像の準備

#### フェーズ 6: 通知処理 ✅

- LINE Bot による処理結果通知
- 変換済み画像の送信

## 📊 出力ファイル

### 自動生成されるファイル

実行完了後、以下のファイルが生成されます：

#### 1. 更新されたマスタ Excel ファイル

```
services/output/YYYYMMDD/角上魚類_updated_YYYYMMDD_HHMMSS.xlsx
```

#### 2. 生成された PDF ファイル

```
services/output/YYYYMMDD/
├── アリスト鶴ヶ島 (LT1)_YYYYMMDD_HHMMSS.pdf
└── ホウスイ川島出庫依頼書_YYYYMMDD_HHMMSS.pdf
```

#### 3. 変換された画像ファイル

```
services/output/YYYYMMDD/
├── アリスト鶴ヶ島 (LT1)_YYYYMMDD_HHMMSS_page_01.jpg
└── ホウスイ川島出庫依頼書_YYYYMMDD_HHMMSS_page_01.jpg
```

#### 4. ログファイル

```
logs/smcl_system_YYYYMMDD.log
```

### ネットワークドライブ保存

ネットワークドライブが利用可能な場合、ファイルは以下にも保存されます：

```
\\sv001\Userdata\納品リスト処理\YYYYMMDD\
├── 角上魚類_updated_YYYYMMDD_HHMMSS.xlsx
├── アリスト鶴ヶ島 (LT1)_YYYYMMDD_HHMMSS.pdf
├── ホウスイ川島出庫依頼書_YYYYMMDD_HHMMSS.pdf
└── 各種画像ファイル
```

## 📱 LINE 通知内容

LINE Bot が設定されている場合、以下の通知が送信されます：

### 1. 処理結果サマリー

```
🎯 SMCL 納品リスト処理完了

📅 処理日時: 2025-01-17 12:34:56
✅ 正常データ: 25件
❌ エラーデータ: 2件
📊 生成Excel: 1ファイル
📄 生成PDF: 2ファイル
🖼️ 変換画像: 2枚
```

### 2. エラー詳細（エラーがある場合）

```
⚠️ エラーデータ詳細

商品コード不一致: 1件
商品名不一致: 1件

詳細はマスタファイルの「エラーリスト」シートを確認してください。
```

### 3. 変換済み画像

- 生成された PDF ファイルの画像版
- LINE 上で直接確認可能

## 🔧 トラブルシューティング

### 実行時エラーの対処

#### 1. Python 関連エラー

```cmd
setup\python_3132_check.bat
```

#### 2. CSV ファイルが見つからない

- `services/downloads/YYYYMMDD/` フォルダを確認
- 手動で CSV ファイルを配置
- ファイル名が `受注伝票_YYYYMMDDHHMMSS.csv` 形式か確認

#### 3. マスタファイルエラー

- `services/docs/角上魚類.xlsx` の存在確認
- ファイルが他のアプリケーションで開かれていないか確認
- ファイルの読み取り権限確認

#### 4. ネットワークドライブエラー

```cmd
# ローカル保存モードで実行
set SMCL_DISABLE_NETWORK=true
run_system.bat
```

#### 5. LINE 通知エラー

```cmd
# LINE設定確認
line_setup_tools\check_line_settings.py
```

### ログファイルの確認

詳細なエラー情報は以下で確認できます：

```cmd
# 最新のログファイルを表示
type logs\smcl_system_*.log | more
```

## ⏰ 自動実行の設定

### タスクスケジューラでの自動実行

毎朝 10:00 に自動実行するには：

```powershell
# PowerShellを管理者として実行
scripts\タスクスケジューラ設定.ps1
```

### 自動実行用バッチファイル

タスクスケジューラでは以下のファイルが実行されます：

```
scripts\自動実行_毎朝10時.bat
```

## 📋 日常運用チェックポイント

### 毎日

- [ ] システムが正常に実行されたか
- [ ] LINE 通知が届いているか
- [ ] エラーがないか

### 週次

- [ ] ログファイルの確認
- [ ] 出力ファイルの整理
- [ ] ネットワークドライブの容量確認

### 月次

- [ ] マスタファイルの更新
- [ ] システムの動作確認
- [ ] 依存関係の更新確認

## 🆘 緊急時の対応

### システムが動作しない場合

1. **基本確認**

   ```cmd
   check_system.bat
   ```

2. **デバッグ情報取得**

   ```cmd
   tools\debug_batch.bat
   ```

3. **手動実行テスト**
   ```cmd
   tools\minimal_test.bat
   ```

### データ処理エラーの場合

1. **ログファイル確認**

   ```cmd
   type logs\smcl_system_*.log
   ```

2. **マスタファイルのエラーリストシート確認**

3. **手動でのデータ修正**

### 緊急時の連絡先

- システム管理者への連絡
- ログファイルとエラーメッセージの共有
- 実行環境情報の提供

## ✅ 実行完了の確認

システム実行が正常に完了した場合：

1. **コンソール出力**

   ```
   ✅ 処理が正常に完了しました
   ```

2. **LINE 通知**

   - 処理結果サマリーの受信
   - 変換済み画像の受信

3. **出力ファイル**

   - 指定フォルダにファイルが生成されている
   - ファイルサイズが 0 でない

4. **ログファイル**
   - エラーメッセージがない
   - 「処理完了」のメッセージがある

これらすべてが確認できれば、システムは正常に動作しています。
